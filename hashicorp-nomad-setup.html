<!DOCTYPE html>
<html>
  <title>HashiCorp Nomad Setup - Vinícius Müller's blog</title>

  <head>
    <link rel="stylesheet" href="https://viniciusmuller.github.io/blog/styles.css"></link>
    
  </head>

  <body>
    
    <nav class="bg-gray-200 w-full px-4 py-2">
      <div class="w-full flex">
          <div class="flex mr-auto space-x-6">
            <a class="text-black font-bold hover:underline" href="https://viniciusmuller.github.io/blog/index.html">Home</a>
            <a class="text-black font-bold hover:underline" href="https://viniciusmuller.github.io/blog/tags.html">Tags</a>

            <!-- <button> -->
            <!--   Search -->
            <!-- </button> -->

            
          </div>

          <div class="flex space-x-6">
            
              <a class="text-black font-bold hover:underline" href="https://github.com/viniciusmuller">GitHub</a>
            

            
              <a class="text-black font-bold hover:underline" href="https://viniciusmuller.github.io/blog/atom.xml">RSS</a>
            
          </div>
        </div>
      </div>
    </nav>
    <main class="p-4 w-full flex justify-center">
      <div class="w-[40vw]">
        
  <div class="flex flex-col items-center">
    <article class='prose my-8'>
      <h1 class="!mb-2">
        HashiCorp Nomad Setup
      </h1>

      <p>
        <span class="font-bold">
          Vinícius Müller
        </span> on February 7, 2023
      </p>

      <div class="space-x-4">
        
          <span class="px-2 py-1 bg-gray-300 rounded-md"> hashicorp </span>
        
          <span class="px-2 py-1 bg-gray-300 rounded-md"> nomad </span>
        
      </div>

      
          <div class="my-8">
            <h2>Table of contents</h2>


  <ul class="!mb-1">
  <a href="#install-nomad">
    <li class="leading-4">
      Install Nomad
      
    </li>
  </a>
</ul>

  <ul class="!mb-1">
  <a href="#setup-the-nomad-agent-unit">
    <li class="leading-4">
      Setup the Nomad Agent Unit
      
    </li>
  </a>
</ul>

  <ul class="!mb-1">
  <a href="#nomad-config">
    <li class="leading-4">
      Nomad Config
      
    </li>
  </a>
</ul>

  <ul class="!mb-1">
  <a href="#running-a-job">
    <li class="leading-4">
      Running a Job
      
    </li>
  </a>
</ul>

  <ul class="!mb-1">
  <a href="#clustering-with-consul">
    <li class="leading-4">
      Clustering with Consul
      
    </li>
  </a>
</ul>

  <ul class="!mb-1">
  <a href="#wrapping-up">
    <li class="leading-4">
      Wrapping up
      
    </li>
  </a>
</ul>

  <ul class="!mb-1">
  <a href="#resources">
    <li class="leading-4">
      Resources
      
    </li>
  </a>
</ul>

          </div>

        

      <div class="mt-8">
        <p>I like HashiCorp's products, and wanted to try running a cluster with some of
them in order to learn more about and build stuff using it. The first one on the
list is Nomad, which this post will cover how to setup it in a single Debian
node and create a cluster. Most of the commands shown here are aggregated and
adapted from the referenced HashiCorp documentation pages.</p>

          <a class="no-underline" href="#install-nomad">
              <h1 id="install-nomad" class="group relative">
              <span class="hidden group-hover:inline absolute -left-8">#</span>
        Install Nomad</h1></a>
<pre><code class="language-sh"># Add HashiCorp's repository
sudo apt-get update &amp;&amp; sudo apt-get install wget gpg coreutils wget lsb-release
wget -O- https://apt.releases.hashicorp.com/gpg | gpg --dearmor | sudo tee /usr/share/keyrings/hashicorp-archive-keyring.gpg
echo &quot;deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main&quot; | sudo tee /etc/apt/sources.list.d/hashicorp.list

# Install nomad
sudo apt-get update &amp;&amp; sudo apt-get install nomad

# Nomad directories and user setup
sudo mkdir -p /opt/nomad
sudo useradd --system --home /etc/nomad.d --shell /bin/false nomad
sudo chown -R nomad /opt/nomad

# Install Docker (optional if you do not pretend to run containers or use podman)
sudo apt-get install docker.io
sudo usermod -G docker -a nomad
</code></pre>
<p>For post-installation steps, such as setting up CNI plugins or Vagrant, refer to
the <a href="https://developer.hashicorp.com/nomad/tutorials/get-started/get-started-install#post-installation-steps">official documentation</a>.</p>

          <a class="no-underline" href="#setup-the-nomad-agent-unit">
              <h1 id="setup-the-nomad-agent-unit" class="group relative">
              <span class="hidden group-hover:inline absolute -left-8">#</span>
        Setup the Nomad Agent Unit</h1></a>
<p>Add the following content into <code>/etc/systemd/system/nomad.service</code>:</p>
<pre><code class="language-toml">[Unit]
Description=Nomad
Documentation=https://www.nomadproject.io/docs/
Wants=network-online.target
After=network-online.target

[Service]

# Nomad server should be run as the nomad user. Nomad clients
# should be run as root
User=nomad
Group=nomad

ExecReload=/bin/kill -HUP $MAINPID
ExecStart=/bin/nomad agent -config /etc/nomad.d
KillMode=process
KillSignal=SIGINT
LimitNOFILE=65536
LimitNPROC=infinity
Restart=on-failure
RestartSec=2
TasksMax=infinity
OOMScoreAdjust=-1000

[Install]
WantedBy=multi-user.target
</code></pre>
<p>Enable and start the Nomad systemd service by running:</p>
<pre><code class="language-sh">sudo systemctl enable nomad
sudo systemctl start nomad
</code></pre>

          <a class="no-underline" href="#nomad-config">
              <h1 id="nomad-config" class="group relative">
              <span class="hidden group-hover:inline absolute -left-8">#</span>
        Nomad Config</h1></a>
<p>Add the following content into <code>/etc/nomad.d/nomad.hcl</code>:</p>
<pre><code class="language-hcl"># Full configuration options can be found at https://www.nomadproject.io/docs/configuration

datacenter = &quot;dc1&quot;

data_dir = &quot;/opt/nomad&quot;
bind_addr = &quot;0.0.0.0&quot;

server {
  enabled = true
}

client {
  enabled = true
}
</code></pre>

          <a class="no-underline" href="#running-a-job">
              <h1 id="running-a-job" class="group relative">
              <span class="hidden group-hover:inline absolute -left-8">#</span>
        Running a Job</h1></a>
<p>Note that this job requires docker to be installed in the host.</p>
<p>Add the following content in a <code>first-job.nomad</code> file:</p>
<pre><code class="language-hcl">job &quot;rabbit&quot; {
  datacenters = [&quot;dc1&quot;]

  group &quot;rabbitmq&quot; {
    network {
      port &quot;rabbit&quot; {
        to = 5672
      }

      port &quot;management&quot; {
        to = 15672
      }
    }

    task &quot;rabbit&quot; {
      driver = &quot;docker&quot;

      config {
        image = &quot;rabbitmq:3-management&quot;
        ports = [&quot;rabbit&quot;, &quot;management&quot;]
        auth_soft_fail = true
      }

      resources {
        cpu = 500
        memory = 512
      }
    }
  }
}
</code></pre>
<p>Then do a dry run of the deployment by running <code>nomad job plan first-job.nomad</code>.</p>
<p>If everything went well, Nomad will tell you it can create the deployment
succesfully and show you the command to start the process. You can then run this
command, wait until it finishes and check the results the <code>Jobs</code> section inside
<a href="127.0.0.1:4646">Nomad's web interface</a>.</p>

          <a class="no-underline" href="#clustering-with-consul">
              <h1 id="clustering-with-consul" class="group relative">
              <span class="hidden group-hover:inline absolute -left-8">#</span>
        Clustering with Consul</h1></a>
<p>In order to create a cluster with our own nodes, we will leverage the existing
Nomad + Consul integration for service discovery. Add the following section to
every Nomad node you want to connect to the cluster:</p>
<pre><code class="language-hcl"># Inside the server block, add bootstrap_expect with the number of nodes that
# you will run in your cluster
server {
  bootstrap_expect = 3
}

consul {
  # The address to the Consul Agent
  address = &quot;consul-ip:5000&quot;

  # The service name to register the server and client with Consul
  server_service_name = &quot;nomad&quot;
  client_service_name = &quot;nomad-client&quot;

  # Enables automatically registering the services
  auto_advertise = true

  # Enabling the server and client to bootstrap using consul
  server_auto_join = true
  client_auto_join = true
}
</code></pre>

          <a class="no-underline" href="#wrapping-up">
              <h1 id="wrapping-up" class="group relative">
              <span class="hidden group-hover:inline absolute -left-8">#</span>
        Wrapping up</h1></a>
<p>Nomad is an awesome scheduler and orchestrator, and it is being pretty
refreshing using its simple API in order to get started learning about
orchestrators. I hope this post helps some curious readers and my future self
when setting Nomad up.</p>
<p>In order to continue learning about Nomad, check <a href="https://developer.hashicorp.com/nomad/docs">HashiCorp's
docs</a>.</p>

          <a class="no-underline" href="#resources">
              <h1 id="resources" class="group relative">
              <span class="hidden group-hover:inline absolute -left-8">#</span>
        Resources</h1></a>
<ul>
<li><a href="https://developer.hashicorp.com/nomad/tutorials/get-started/get-started-install">Install Nomad</a></li>
<li><a href="https://developer.hashicorp.com/nomad/tutorials/enterprise/production-deployment-guide-vm-with-consul">Nomad Deployment Guide</a></li>
<li><a href="https://developer.hashicorp.com/nomad/tutorials/get-started/get-started-run">Start Nomad and Run Your First Job</a></li>
<li><a href="https://developer.hashicorp.com/nomad/tutorials/manage-clusters/clustering">Connect Nodes into a Cluster</a></li>
</ul>

      </div>
    </article>
  <div>

      </div>
    </main>
  </body>
</html>