<!DOCTYPE html>
<html>
  <title>Hybrid Graphics with NVIDIA PRIME - Vinícius Müller's blog</title>

  <head>
    <link rel="stylesheet" href="https://viniciusmuller.github.io/blog/styles.css"></link>
    
  </head>

  <body>
    
    <nav class="bg-gray-200 w-full px-4 py-2">
      <div class="w-full flex">
          <div class="flex mr-auto space-x-6">
            <a class="text-black font-bold hover:underline" href="https://viniciusmuller.github.io/blog/index.html">Home</a>
            <a class="text-black font-bold hover:underline" href="https://viniciusmuller.github.io/blog/tags.html">Tags</a>

            <!-- <button> -->
            <!--   Search -->
            <!-- </button> -->

            
          </div>

          <div class="flex space-x-6">
            
              <a class="text-black font-bold hover:underline" href="https://github.com/viniciusmuller">GitHub</a>
            

            
              <a class="text-black font-bold hover:underline" href="https://viniciusmuller.github.io/blog/atom.xml">RSS</a>
            
          </div>
        </div>
      </div>
    </nav>
    <main class="p-4 w-full flex justify-center">
      <div class="w-[40vw]">
        
  <div class="flex flex-col items-center">
    <article class='prose my-8'>
      <h1 class="!mb-2">
        Hybrid Graphics with NVIDIA PRIME
      </h1>

      <p>
        <span class="font-bold">
          Vinícius Müller
        </span> on October 27, 2021
      </p>

      <div class="space-x-4">
        
      </div>

      
      

      <div class="mt-8">
        
          <a class="no-underline" href="#table-of-contents">
              <h1 id="table-of-contents" class="group relative">
              <span class="hidden group-hover:inline absolute -left-8">#</span>
        Table of Contents</h1></a>
<!-- raw HTML omitted -->

          <a class="no-underline" href="#intro">
              <h1 id="intro" class="group relative">
              <span class="hidden group-hover:inline absolute -left-8">#</span>
        Intro</h1></a>
<p>I've spent some time trying to setup hybrid graphics on NixOS and managed to get
it up and running after adapting some of the content available at the NixOS Wiki.
This post will go through the necessary changes that I had to do in order to get
it working.</p>

          <a class="no-underline" href="#author-s-setup">
              <h2 id="author-s-setup" class="group relative">
              <span class="hidden group-hover:inline absolute -left-8">#</span>
        Author's Setup</h2></a>
<p>The relevant setup for this post includes:</p>
<ul>
<li>OS: <code>NixOS 21.11 Porcupine</code></li>
<li>CPU: <code>Intel i7-7700</code></li>
<li>GPU: <code>NVIDIA GTX 1070</code></li>
<li>iGPU: <code>Intel HD Graphics 630</code></li>
</ul>
<blockquote>
<p>Note: I have not tested this in other machines, maybe some changes will be
necessary for this to run in other kinds of hardware.</p>
</blockquote>

          <a class="no-underline" href="#nixos-configuration">
              <h1 id="nixos-configuration" class="group relative">
              <span class="hidden group-hover:inline absolute -left-8">#</span>
        NixOS Configuration</h1></a>
<p>Below is the necessary NixOS configuration to get it up and running. The
relevant parts will be covered next.</p>
<pre><code class="language-nix">let
  nvidia-offload = pkgs.writeShellScriptBin &quot;nvidia-offload&quot; ''
    export __NV_PRIME_RENDER_OFFLOAD=1
    export __NV_PRIME_RENDER_OFFLOAD_PROVIDER=NVIDIA-G0
    export __GLX_VENDOR_LIBRARY_NAME=nvidia
    export __VK_LAYER_NV_optimus=NVIDIA_only
    exec -a &quot;$1&quot; &quot;$@&quot;
  '';
in
{
  environment.systemPackages = [
    nvidia-offload
  ];

  services.xserver.config = ''
    # Integrated Intel GPU
    Section &quot;Device&quot;
      Identifier &quot;iGPU&quot;
      Driver &quot;modesetting&quot;
    EndSection

    # Dedicated NVIDIA GPU
    Section &quot;Device&quot;
      Identifier &quot;dGPU&quot;
      Driver &quot;nvidia&quot;
    EndSection

    Section &quot;ServerLayout&quot;
      Identifier &quot;layout&quot;
      Screen 0 &quot;iGPU&quot;
    EndSection

    Section &quot;Screen&quot;
      Identifier &quot;iGPU&quot;
      Device &quot;iGPU&quot;
    EndSection
  '';

  services.xserver.videoDrivers = [ &quot;nvidia&quot; ];
  hardware.nvidia.prime = {
    offload.enable = true;
    intelBusId = &quot;PCI:0:2:0&quot;;
    nvidiaBusId = &quot;PCI:1:0:0&quot;;
  };
}
</code></pre>

          <a class="no-underline" href="#offload-script">
              <h2 id="offload-script" class="group relative">
              <span class="hidden group-hover:inline absolute -left-8">#</span>
        Offload Script</h2></a>
<pre><code class="language-nix">let
  nvidia-offload = pkgs.writeShellScriptBin &quot;nvidia-offload&quot; ''
    export __NV_PRIME_RENDER_OFFLOAD=1
    export __NV_PRIME_RENDER_OFFLOAD_PROVIDER=NVIDIA-G0
    export __GLX_VENDOR_LIBRARY_NAME=nvidia
    export __VK_LAYER_NV_optimus=NVIDIA_only
    exec -a &quot;$1&quot; &quot;$@&quot;
  '';
in
{
  environment.systemPackages = [
    nvidia-offload
  ];
}
</code></pre>
<p>This defines a small helper script that you will be using when you want to launch a program using the dedicated GPU.</p>

          <a class="no-underline" href="#examples">
              <h3 id="examples" class="group relative">
              <span class="hidden group-hover:inline absolute -left-8">#</span>
        Examples</h3></a>
<ul>
<li>Launching glxgears using the integrated GPU: <code>glxgears</code></li>
<li>Launching glxgears using the dedicated GPU: <code>nvidia-offload glxgears</code></li>
</ul>
<blockquote>
<p>Extra: Launch Steam games using the GPU:</p>
<ul>
<li>Go at the game properties inside the Steam client</li>
<li>Find <code>Launch Options</code></li>
<li>If it's empty, change it to <code>nvidia-offload %command%</code></li>
</ul>
</blockquote>

          <a class="no-underline" href="#xserver-configuration">
              <h2 id="xserver-configuration" class="group relative">
              <span class="hidden group-hover:inline absolute -left-8">#</span>
        XServer Configuration</h2></a>
<pre><code class="language-nix">services.xserver.config = ''
  # Integrated Intel GPU
  Section &quot;Device&quot;
    Identifier &quot;iGPU&quot;
    Driver &quot;modesetting&quot;
  EndSection

  # Dedicated NVIDIA GPU
  Section &quot;Device&quot;
    Identifier &quot;dGPU&quot;
    Driver &quot;nvidia&quot;
  EndSection

  Section &quot;ServerLayout&quot;
    Identifier &quot;layout&quot;
    Screen 0 &quot;iGPU&quot;
  EndSection

  Section &quot;Screen&quot;
    Identifier &quot;iGPU&quot;
    Device &quot;iGPU&quot;
  EndSection
'';
</code></pre>
<p>This was necessary for me because the XServer was not recognizing
my graphics card, adding this extra piece of configuration solved it.</p>

          <a class="no-underline" href="#nvidia-prime-configuration">
              <h2 id="nvidia-prime-configuration" class="group relative">
              <span class="hidden group-hover:inline absolute -left-8">#</span>
        NVIDIA + PRIME Configuration</h2></a>
<pre><code class="language-nix">services.xserver.videoDrivers = [ &quot;nvidia&quot; ];

hardware.nvidia.prime = {
  offload.enable = true;
  intelBusId = &quot;PCI:0:2:0&quot;;
  nvidiaBusId = &quot;PCI:1:0:0&quot;;
};
</code></pre>
<p>The first line here enables the <strong>proprietary NVIDIA drivers</strong> in our system, this
line is very important, otherwise it will not work.</p>
<p>Below is the NVIDIA PRIME configuration, in which we must enable <code>offload</code> and
the both the <code>nvidiaBusId</code> and <code>intelBusId</code> of our GPUs. You can find out how to
get the bus ids by reading this <a href="https://nixos.wiki/wiki/Nvidia#lspci">relevant part of the NixOS Wiki</a>.</p>
<blockquote>
<p>Note: In my system, I had to go to my BIOS settings and change the default
display output to <code>IGFX</code> (Integrated Graphics) instead of directly using the
PCIE slot, otherwise my system wouldn't detect the Intel HD device.</p>
</blockquote>

          <a class="no-underline" href="#conclusion">
              <h1 id="conclusion" class="group relative">
              <span class="hidden group-hover:inline absolute -left-8">#</span>
        Conclusion</h1></a>
<p>After some tries I could get hybrid graphics working on NixOS in a quite easy
and reproducible way. This is a writeup meant to help other people with the same
issue and remember myself about it if I ever need to change it again.</p>

          <a class="no-underline" href="#resources">
              <h1 id="resources" class="group relative">
              <span class="hidden group-hover:inline absolute -left-8">#</span>
        Resources</h1></a>
<ul>
<li><a href="https://nixos.wiki/wiki/Nvidia">NixOS Wiki's NVIDIA page</a></li>
<li><a href="https://download.nvidia.com/XFree86/Linux-x86_64/435.17/README/primerenderoffload.html">NVIDIA's PRIME Offloading</a></li>
</ul>

      </div>
    </article>
  <div>

      </div>
    </main>
  </body>
</html>