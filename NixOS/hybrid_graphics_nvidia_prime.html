<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Hybrid Graphics with NVIDIA PRIME - My blog</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><div>Nix</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../Nix/flakes_cheat_sheet.html">Nix Flakes Cheat Sheet</a></li></ol></li><li class="chapter-item expanded "><div>NixOS</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../NixOS/gpu_passthrough.html">KVM GPU Passthrough</a></li><li class="chapter-item expanded "><a href="../NixOS/hybrid_graphics_nvidia_prime.html" class="active">Hybrid Graphics with NVIDIA PRIME</a></li><li class="chapter-item "><a href="../NixOS/kmonad_remappings.html">Elegant remappings with KMonad</a></li><li class="chapter-item "><a href="../NixOS/setting_background_image.html">Setting XServer's Background Image</a></li></ol></li><li class="chapter-item expanded "><a href="../index.html">Introduction</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">My blog</h1>

                    <div class="right-buttons">
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="table-of-contents"><a class="header" href="#table-of-contents">Table of Contents</a></h1>
<ul>
<li><a href="#intro">Intro</a>
<ul>
<li><a href="#authors-setup">Author's Setup</a></li>
</ul>
</li>
<li><a href="#nixos-configuration">NixOS Configuration</a>
<ul>
<li><a href="#offload-script">Offload Script</a>
<ul>
<li><a href="#examples">Examples</a></li>
</ul>
</li>
<li><a href="#xserver-configuration">XServer Configuration</a></li>
<li><a href="#nvidia--prime-configuration">NVIDIA + PRIME Configuration</a></li>
</ul>
</li>
<li><a href="#conclusion">Conclusion</a></li>
<li><a href="#resources">Resources</a></li>
</ul>
<h1 id="intro"><a class="header" href="#intro">Intro</a></h1>
<p>I've spent some time trying to setup hybrid graphics on NixOS and managed to get
it up and running after adapting some of the content available at the NixOS Wiki.
This post will go through the necessary changes that I had to do in order to get
it working.</p>
<h2 id="authors-setup"><a class="header" href="#authors-setup">Author's Setup</a></h2>
<p>The relevant setup for this post includes:</p>
<ul>
<li>OS: <code>NixOS 21.11 Porcupine</code></li>
<li>CPU: <code>Intel i7-7700</code></li>
<li>GPU: <code>NVIDIA GTX 1070</code></li>
<li>iGPU: <code>Intel HD Graphics 630</code></li>
</ul>
<blockquote>
<p>Note: I have not tested this in other machines, maybe some changes will be
necessary for this to run in other kinds of hardware.</p>
</blockquote>
<h1 id="nixos-configuration"><a class="header" href="#nixos-configuration">NixOS Configuration</a></h1>
<p>Below is the necessary NixOS configuration to get it up and running. The
relevant parts will be covered next.</p>
<pre><code class="language-nix">let
  nvidia-offload = pkgs.writeShellScriptBin &quot;nvidia-offload&quot; ''
    export __NV_PRIME_RENDER_OFFLOAD=1
    export __NV_PRIME_RENDER_OFFLOAD_PROVIDER=NVIDIA-G0
    export __GLX_VENDOR_LIBRARY_NAME=nvidia
    export __VK_LAYER_NV_optimus=NVIDIA_only
    exec -a &quot;$1&quot; &quot;$@&quot;
  '';
in
{
  environment.systemPackages = [
    nvidia-offload
  ];

  services.xserver.config = ''
    # Integrated Intel GPU
    Section &quot;Device&quot;
      Identifier &quot;iGPU&quot;
      Driver &quot;modesetting&quot;
    EndSection

    # Dedicated NVIDIA GPU
    Section &quot;Device&quot;
      Identifier &quot;dGPU&quot;
      Driver &quot;nvidia&quot;
    EndSection

    Section &quot;ServerLayout&quot;
      Identifier &quot;layout&quot;
      Screen 0 &quot;iGPU&quot;
    EndSection

    Section &quot;Screen&quot;
      Identifier &quot;iGPU&quot;
      Device &quot;iGPU&quot;
    EndSection
  '';

  services.xserver.videoDrivers = [ &quot;nvidia&quot; ];
  hardware.nvidia.prime = {
    offload.enable = true;
    intelBusId = &quot;PCI:0:2:0&quot;;
    nvidiaBusId = &quot;PCI:1:0:0&quot;;
  };
}
</code></pre>
<h2 id="offload-script"><a class="header" href="#offload-script">Offload Script</a></h2>
<pre><code class="language-nix">let
  nvidia-offload = pkgs.writeShellScriptBin &quot;nvidia-offload&quot; ''
    export __NV_PRIME_RENDER_OFFLOAD=1
    export __NV_PRIME_RENDER_OFFLOAD_PROVIDER=NVIDIA-G0
    export __GLX_VENDOR_LIBRARY_NAME=nvidia
    export __VK_LAYER_NV_optimus=NVIDIA_only
    exec -a &quot;$1&quot; &quot;$@&quot;
  '';
in
{
  environment.systemPackages = [
    nvidia-offload
  ];
}
</code></pre>
<p>This defines a small helper script that you will be using when you want to launch a program using the dedicated GPU.</p>
<h3 id="examples"><a class="header" href="#examples">Examples</a></h3>
<ul>
<li>Launching glxgears using the integrated GPU: <code>glxgears</code></li>
<li>Launching glxgears using the dedicated GPU: <code>nvidia-offload glxgears</code></li>
</ul>
<blockquote>
<p>Extra: Launch Steam games using the GPU:</p>
<ul>
<li>Go at the game properties inside the Steam client</li>
<li>Find <code>Launch Options</code></li>
<li>If it's empty, change it to <code>nvidia-offload %command%</code></li>
</ul>
</blockquote>
<h2 id="xserver-configuration"><a class="header" href="#xserver-configuration">XServer Configuration</a></h2>
<pre><code class="language-nix">services.xserver.config = ''
  # Integrated Intel GPU
  Section &quot;Device&quot;
    Identifier &quot;iGPU&quot;
    Driver &quot;modesetting&quot;
  EndSection

  # Dedicated NVIDIA GPU
  Section &quot;Device&quot;
    Identifier &quot;dGPU&quot;
    Driver &quot;nvidia&quot;
  EndSection

  Section &quot;ServerLayout&quot;
    Identifier &quot;layout&quot;
    Screen 0 &quot;iGPU&quot;
  EndSection

  Section &quot;Screen&quot;
    Identifier &quot;iGPU&quot;
    Device &quot;iGPU&quot;
  EndSection
'';
</code></pre>
<p>This was necessary for me because the XServer was not recognizing
my graphics card, adding this extra piece of configuration solved it.</p>
<h2 id="nvidia--prime-configuration"><a class="header" href="#nvidia--prime-configuration">NVIDIA + PRIME Configuration</a></h2>
<pre><code class="language-nix">services.xserver.videoDrivers = [ &quot;nvidia&quot; ];

hardware.nvidia.prime = {
  offload.enable = true;
  intelBusId = &quot;PCI:0:2:0&quot;;
  nvidiaBusId = &quot;PCI:1:0:0&quot;;
};
</code></pre>
<p>The first line here enables the <code>proprietary NVIDIA driver</code> in our system, this
line is very important, otherwise it will not work.</p>
<p>Below is the NVIDIA PRIME configuration, in which we must enable <code>offload</code> and
the both the <code>nvidiaBusId</code> and <code>intelBusId</code> of our GPUs. You can find out how to
get the bus ids by reading this <a href="https://nixos.wiki/wiki/Nvidia#lspci">relevant part of the NixOS Wiki</a>.</p>
<blockquote>
<p>Note: In my system, I had to go to my BIOS settings and change the default
display output to <code>IGFX</code> (Integrated Graphics) instead of directly using the
PCIE slot, otherwise my system wouldn't detect the Intel HD device.</p>
</blockquote>
<h1 id="conclusion"><a class="header" href="#conclusion">Conclusion</a></h1>
<p>After some tries I could get hybrid graphics working on NixOS in a quite easy
and reproducible way. This is a writeup meant to help other people with the same
issue and remember myself about it if I ever need to change it again.</p>
<h1 id="resources"><a class="header" href="#resources">Resources</a></h1>
<ul>
<li><a href="https://nixos.wiki/wiki/Nvidia">NixOS Wiki's NVIDIA page</a></li>
<li><a href="https://download.nvidia.com/XFree86/Linux-x86_64/435.17/README/primerenderoffload.html">NVIDIA's PRIME Offloading</a></li>
</ul>
<div class="datetime" style="text-align: center; color: gray; font-style: italic; font-size: 90%;">16:47 Wednesday 27 October 2021</div>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.18/dist/katex.min.css" integrity="sha384-zTROYFVGOfTw7JV7KUu8udsvW2fx4lWOsCEDqhBreBwlHI4ioVRtmIvEThzJHGET" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.20/dist/katex.min.js" integrity="sha384-ov99pRO2tAc0JuxTVzf63RHHeQTJ0CIawbDZFiFTzB07aqFZwEu2pz4uzqL+5OPG" crossorigin="anonymous"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    var math = document.querySelectorAll("[class^=katex]");
    for (var i = 0; i < math.length; i++) {
      // Convert escaped ampersands before rendering
      var toRender = math[i].textContent.replace(/&amp;/g, '&');
      katex.render(toRender, math[i]);
    }
}, false)
</script>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../NixOS/gpu_passthrough.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../NixOS/kmonad_remappings.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../NixOS/gpu_passthrough.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../NixOS/kmonad_remappings.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
