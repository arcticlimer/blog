<!DOCTYPE html>
<html>
  <title>Setting ZFS mirrors up in NixOS - Vinícius Müller's blog</title>

  <head>
    <link rel="stylesheet" href="https://viniciusmuller.github.io/blog/styles.css"></link>
    
  </head>

  <body>
    
    <nav class="bg-gray-200 w-full px-4 py-2">
      <div class="w-full flex">
          <div class="flex mr-auto space-x-6">
            <a class="text-black font-bold hover:underline" href="https://viniciusmuller.github.io/blog/index.html">Home</a>
            <a class="text-black font-bold hover:underline" href="https://viniciusmuller.github.io/blog/tags.html">Tags</a>

            <!-- <button> -->
            <!--   Search -->
            <!-- </button> -->

            
          </div>

          <div class="flex space-x-6">
            
              <a class="text-black font-bold hover:underline" href="https://github.com/viniciusmuller">GitHub</a>
            

            
              <a class="text-black font-bold hover:underline" href="https://viniciusmuller.github.io/blog/atom.xml">RSS</a>
            
          </div>
        </div>
      </div>
    </nav>
    <main class="p-4 w-full flex justify-center">
      <div class="w-[40vw]">
        
  <div class="flex flex-col items-center">
    <article class='prose my-8'>
      <h1 class="!mb-2">
        Setting ZFS mirrors up in NixOS
      </h1>

      <p>
        <span class="font-bold">
          Vinícius Müller
        </span> on September 13, 2022
      </p>

      <div class="space-x-4">
        
      </div>

      
      

      <div class="mt-8">
        
          <a class="no-underline" href="#zfs">
              <h1 id="zfs" class="group relative">
              <span class="hidden group-hover:inline absolute -left-8">#</span>
        ZFS</h1></a>
<p>ZFS is a modern file system that works with pool of different devices and allows
for redudancy, efficient snapshots, compression and deduplication.</p>

          <a class="no-underline" href="#setup">
              <h1 id="setup" class="group relative">
              <span class="hidden group-hover:inline absolute -left-8">#</span>
        Setup</h1></a>
<blockquote>
<p>Warning: When experimenting with different partitioning schemas, if you happen
to create any pool or dataset using <code>zpool create</code> or <code>zfs create</code>, remember
to delete them before using the proper pool and dataset deletion commands before
repartitioning, otherwise you will get stuck with &quot;phantom&quot; ZFS pools that will
be very annoying to remove.</p>
</blockquote>
<pre><code class="language-sh">POOL_NAME=main
DATASET_NAME=root
DISK_ONE=disk_one_path
DISK_TWO=disk_two_path

# Use cfdisk or some other tool to partition your disks.
# In my case I've created the following partition table in both disks:
# 100M BIOS Boot
# 4G Linux Swap
# Remaining space ZFS
cfdisk $DISK_ONE
cfdisk $DISK_TWO

zpool create -O mountpoint=none -O compression=lz4 $POOL_NAME mirror $DISK_ONE-part3 $DISK_TWO-part3
zfs create -o mountpoint=legacy $POOL_NAME/$DATASET_NAME

mkfs.vfat $DISK_ONE-part1
mkfs.vfat $DISK_TWO-part1

# Activate only one of these using `swapon`
mkswap $DISK_ONE-part2
mkswap $DISK_TWO-part2

swapon $DISK_ONE-part2

mount -t zfs $POOL_NAME/$DATASET_NAME /mnt
nixos-generate-config --root /mnt

# Tweak your configurations and install NixOS
nixos-install
</code></pre>
<p>In order to setup two boot partitions in NixOs, use the
<code>boot.loader.grub.devices</code> attribute:</p>
<pre><code class="language-nix">boot.loader.grub.devices = [ &quot;/dev/sda&quot; &quot;/dev/sdb&quot; ];
</code></pre>
<p>Now if one of the disks die you will still be able to boot into your system.</p>

          <a class="no-underline" href="#replacing-devices">
              <h1 id="replacing-devices" class="group relative">
              <span class="hidden group-hover:inline absolute -left-8">#</span>
        Replacing devices</h1></a>
<p>Just a few days after doing the first installation, one of the hard drives being
used died. It was surprisingly easy to repair my mirror using some ZFS magic.</p>
<pre><code>[root@nixos:~]# zpool status
  pool: main
 state: DEGRADED
status: One or more devices could not be used because the label is missing or
        invalid.  Sufficient replicas exist for the pool to continue
        functioning in a degraded state.
action: Replace the device using 'zpool replace'.
   see: https://openzfs.github.io/openzfs-docs/msg/ZFS-8000-4J
config:

        NAME                              STATE     READ WRITE CKSUM
        main                              DEGRADED     0     0     0
          mirror-0                        DEGRADED     0     0     0
            &lt;device_id&gt;                   UNAVAIL      0     0     0  was /dev/disk/by-id/wwn-0x5000c5007b582f48-part3
            wwn-0x5000c50074fbe272-part3  ONLINE       0     0     0
</code></pre>
<p>In order to repair a pool, run the following command:</p>
<pre><code class="language-sh">zpool replace &lt;pool&gt; &lt;device_id&gt; &lt;new_device_path&gt;
</code></pre>
<p>Then ZFS will start the resilvering process and your mirror will be ready again
some time later.</p>

          <a class="no-underline" href="#samba">
              <h1 id="samba" class="group relative">
              <span class="hidden group-hover:inline absolute -left-8">#</span>
        Samba</h1></a>
<p>Samba allows the server to be easily usable from both Windows and Linux clients.</p>
<pre><code class="language-nix">services.samba = {
  enable = true;
  extraConfig = ''
    hosts allow = 192.168.1. 127.0.0.1 localhost
  '';
  shares = {
    samba = {
      path = &quot;/home/vini/smb&quot;;
      &quot;read only&quot; = &quot;no&quot;;
    };
  };
};
</code></pre>
<blockquote>
<p>For some reason, samba gives &quot;read only drive&quot; errors if the share and
directory name are the same.</p>
</blockquote>
<p>Register a samba user:</p>
<pre><code class="language-sh">smbpasswd -a &lt;samba_user&gt;
</code></pre>
<p>Now whenever you need to access your files, just log in using this user.</p>

      </div>
    </article>
  <div>

      </div>
    </main>
  </body>
</html>