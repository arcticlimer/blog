<!DOCTYPE html>
<html>
  <title>Fixing manually deleted Docker volume - Vinícius Müller's blog</title>

  <head>
    <link rel="stylesheet" href="https://viniciusmuller.github.io/blog/styles.css"></link>
    
  </head>

  <body>
    
    <nav class="bg-gray-200 w-full px-4 py-2">
      <div class="w-full flex">
          <div class="flex mr-auto space-x-6">
            <a class="text-black font-bold hover:underline" href="https://viniciusmuller.github.io/blog/index.html">Home</a>
            <a class="text-black font-bold hover:underline" href="https://viniciusmuller.github.io/blog/tags.html">Tags</a>

            <!-- <button> -->
            <!--   Search -->
            <!-- </button> -->

            
          </div>

          <div class="flex space-x-6">
            
              <a class="text-black font-bold hover:underline" href="https://github.com/viniciusmuller">GitHub</a>
            

            
              <a class="text-black font-bold hover:underline" href="https://viniciusmuller.github.io/blog/atom.xml">RSS</a>
            
          </div>
        </div>
      </div>
    </nav>
    <main class="p-4 w-full flex justify-center">
      <div class="w-[40vw]">
        
  <div class="flex flex-col items-center">
    <article class='prose my-8'>
      <h1 class="!mb-2">
        Fixing manually deleted Docker volume
      </h1>

      <p>
        <span class="font-bold">
          Vinícius Müller
        </span> on January 4, 2023
      </p>

      <div class="space-x-4">
        
      </div>

      
      

      <div class="mt-8">
        <p>Let's say you have a docker-compose file that looks like this:</p>
<pre><code class="language-yaml">version: '3.1'

services:

  db:
    image: postgres
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: my_db
    volumes:
      - db-data:/var/lib/postgresql/data
    ports:
      - 5432:5432


volumes:
  db-data:
</code></pre>
<p>If you're not thinking straight or are not very experienced with docker, you may
delete your volume in order to clean it using something similar to the following command:</p>
<pre><code class="language-bash">sudo rm -rf /var/lib/docker/volumes/db-data
</code></pre>
<p>And then you proceed to run your containers normally with docker compose,
and boom!</p>
<pre><code class="language-bash">❯ docker compose up
[+] Running 1/0
 ⠿ Network default  Created                                                                                 0.0s
 ⠋ Container db-1   Creating                                                                                0.0s
Error response from daemon: open /var/lib/docker/volumes/db-data/_data: no such file or directory
</code></pre>
<p>Now we can't run our containers, what should we do!?</p>
<p>Doing a quick google search, we see that docker compose has the following flag:</p>
<pre><code>-V, --renew-anon-volumes   Recreate anonymous volumes instead of retrieving
                           data from the previous containers.
</code></pre>
<p>Now it seems that this battle is already won, but surprisingly, when using
<strong>docker v20.10.21</strong> and <strong>docker-compose v2.14.0</strong>, adding this flag to <code>docker compose up</code> does nothing, the error still persists and no volume is recreated.</p>
<p>The way that I've solved this is actually pretty stupid, but it works:</p>
<pre><code class="language-bash">sudo mkdir -p /var/lib/docker/volumes/db-data/_data
</code></pre>
<p>Creating these folders is already enough for <code>docker-compose</code> to continue from
there and run our containers.</p>
<p>And maybe the key takeway from this is to remember to use <code>docker volume rm</code>
when wiping volumes, so we don't run through this again.</p>

      </div>
    </article>
  <div>

      </div>
    </main>
  </body>
</html>